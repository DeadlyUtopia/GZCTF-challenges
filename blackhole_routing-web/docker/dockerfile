# 使用 Ubuntu 22.04（jammy）
FROM ubuntu:jammy

# 基础环境
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV GZCTF_FLAG="flag{abnormal_ip_banned_final_success}"

# 国内源（阿里云）
RUN echo "deb http://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiverse" > /etc/apt/sources.list && \
    echo "deb http://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiverse" >> /etc/apt/sources.list && \
    echo "deb http://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiverse" >> /etc/apt/sources.list && \
    echo "deb http://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiverse" >> /etc/apt/sources.list

# 安装依赖（注意反斜杠和注释空格）
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 \
    python3-pip \
    python3-flask \
    iproute2 \
    net-tools \
    inetutils-ping \
    bash \
    && rm -rf /var/lib/apt/lists/*

# 创建 ctfuser 用户（UID=1000）
RUN useradd -m -u 1000 -s /bin/bash ctfuser && \
    mkdir -p /home/ctfuser && \
    chown -R ctfuser:ctfuser /home/ctfuser

# 设置工作目录并复制代码
WORKDIR /app
COPY web/app.py /app/
COPY web/templates /app/templates/

# 权限设置
RUN chown -R root:root /app && \
    chmod 700 /app && \
    chmod 755 /home/ctfuser && \
    chmod 755 /app/app.py

# 暴露端口
EXPOSE 5000

# 启动 Flask
CMD ["python3", "/app/app.py"]
