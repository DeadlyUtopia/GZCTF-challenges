#!/bin/sh
echo $GZCTF_FLAG 
echo "# FLAG is the password for Lanproxy login" >> /etc/passwd

# 验证添加结果
if grep -q "# FLAG is the password for Lanproxy login" /etc/passwd; then
    echo "Fakse Flag added successfully (as comment) to /etc/passwd"
else
    echo "Failed to add faske flag to /etc/passwd"
    exit 1
fi

echo "FLAG is not here" >> /flag && \
chmod 444 /flag
echo "Created /flag file with read-only permissions"

CONFIG_FILE="/lanproxy/proxy-server-0.1/conf/config.properties"

sed -i "s|config.admin.username=admin|config.admin.username=FLAG|g" "$CONFIG_FILE"
# 替换原密码行，增加变量为空的判断
#    if [ -n "$GZCTF_FLAG" ]; then
# 对flag中的特殊字符进行转义（处理&、\、/等）
echo "检测到GZCTF_FLAG：$GZCTF_FLAG"
ESCAPED_FLAG=$(echo "$GZCTF_FLAG" | sed 's/[\/&]/\\&/g')
echo "转义后的值：$ESCAPED_FLAG"
sed -i "s|config.admin.password=admin|config.admin.password=$ESCAPED_FLAG|g" "$CONFIG_FILE"
#    else
#        RANDOM_FLAG=$(head -c 16 /dev/urandom | tr -dc 'a-zA-Z0-9' | head -c 16)
#        ESCAPED_RANDOM=$(echo "$RANDOM_FLAG" | sed 's/[\/&]/\\&/g')
#        echo "Warning: GZCTF_FLAG is not set, generated random password: $ESCAPED_RANDOM"
#        # 同样用|作为分隔符
#        sed -i "s|config.admin.password=admin|config.admin.password=$ESCAPED_RANDOM|g" "$CONFIG_FILE"
#    fi