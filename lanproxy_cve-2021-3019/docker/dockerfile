# 基础镜像：使用OpenJDK 8 JRE（精简版，仅含运行环境，体积小）
FROM maven:3-openjdk-8

# 创建工作目录，用于存放lanproxy
WORKDIR /lanproxy

COPY ./proxy-server-0.1.zip /lanproxy/

# 解压压缩包，并删除压缩包（减少镜像体积）
RUN unzip proxy-server-0.1.zip && \
    rm -f proxy-server-0.1.zip

# flag
COPY ./flag.sh /lanproxy/
RUN chmod +x flag.sh
# RUN /lanproxy/flag.sh && rm -f /lanproxy/flag.sh

COPY ./startup-1.sh /lanproxy/proxy-server-0.1/bin/startup-1.sh

RUN chmod +x /lanproxy/proxy-server-0.1/bin/startup.sh && \
    chmod +x /lanproxy/proxy-server-0.1/bin/stop.sh && \
    chmod +x /lanproxy/proxy-server-0.1/bin/startup-1.sh

# 暴露lanproxy默认端口（需根据实际配置调整）
# - 8090：管理界面端口
EXPOSE 8090

CMD ["/bin/sh", "-c", "/lanproxy/proxy-server-0.1/bin/startup.sh & \
    sleep 3; \
    /lanproxy/proxy-server-0.1/bin/stop.sh; \
    /lanproxy/flag.sh; \
    rm -f /lanproxy/flag.sh; \
    /lanproxy/proxy-server-0.1/bin/startup-1.sh"]


# COPY ./init.sh /lanproxy/
# RUN chmod +x /lanproxy/init.sh
# CMD ["/lanproxy/init.sh"]