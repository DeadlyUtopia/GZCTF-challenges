FROM debian:bullseye-slim

ENV MYSQL_ROOT_PASSWORD=c07138ebe915fa51d5a365b33f5b4f9a \
    MYSQL_DATABASE=ry \
    JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64 \
    PATH=$PATH:$JAVA_HOME/bin:/usr/local/maven/bin \
    LANG=C.UTF-8 \
    DEBIAN_FRONTEND=noninteractive

RUN echo "deb http://mirrors.aliyun.com/debian/ bullseye main non-free contrib" > /etc/apt/sources.list && \
    echo "deb http://mirrors.aliyun.com/debian-security/ bullseye-security main" >> /etc/apt/sources.list && \
    echo "deb http://mirrors.aliyun.com/debian/ bullseye-updates main non-free contrib" >> /etc/apt/sources.list && \
    apt-get update

RUN apt-get install -y --no-install-recommends \
    openjdk-11-jdk \
    maven \
    default-mysql-server \
    supervisor \
    unzip \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

ENV JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64

RUN mkdir -p /var/run/mysqld && chown -R mysql:mysql /var/run/mysqld /var/lib/mysql \
    && mkdir -p /etc/mysql/conf.d \
    && echo "[mysqld]" > /etc/mysql/conf.d/ruoyi.cnf \
    && echo "lower_case_table_names=1" >> /etc/mysql/conf.d/ruoyi.cnf \
    && echo "character-set-server=utf8mb4" >> /etc/mysql/conf.d/ruoyi.cnf \
    && echo "collation-server=utf8mb4_general_ci" >> /etc/mysql/conf.d/ruoyi.cnf \
    && echo "skip-networking=0" >> /etc/mysql/conf.d/ruoyi.cnf \
    && echo "bind-address=127.0.0.1" >> /etc/mysql/conf.d/ruoyi.cnf \
    && echo "# 低内存优化" >> /etc/mysql/conf.d/ruoyi.cnf \
    && echo "performance_schema=OFF" >> /etc/mysql/conf.d/ruoyi.cnf \
    && echo "innodb_buffer_pool_size=128M" >> /etc/mysql/conf.d/ruoyi.cnf \
    && echo "max_connections=50" >> /etc/mysql/conf.d/ruoyi.cnf \
    && echo "table_open_cache=64" >> /etc/mysql/conf.d/ruoyi.cnf \
    && echo "innodb_log_file_size=32M" >> /etc/mysql/conf.d/ruoyi.cnf

WORKDIR /app
COPY RuoYi-v4.8.1.zip /app/
RUN unzip -q RuoYi-v4.8.1.zip -d /app && rm -f RuoYi-v4.8.1.zip
COPY custom-config/application.yml /app/RuoYi-v4.8.1/ruoyi-admin/src/main/resources/
COPY custom-config/application-druid.yml /app/RuoYi-v4.8.1/ruoyi-admin/src/main/resources/
COPY custom-config/logback.xml /app/RuoYi-v4.8.1/ruoyi-admin/src/main/resources/
RUN cd /app/RuoYi-v4.8.1 && mvn clean package -DskipTests

RUN mkdir -p /var/log/supervisor
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

RUN mkdir -p /docker-entrypoint-initdb.d && \
    echo '#!/bin/bash' > /docker-entrypoint-initdb.d/init.sh && \
    echo 'sleep 25' >> /docker-entrypoint-initdb.d/init.sh && \
    echo '# MariaDB使用unix_socket认证，先用sudo方式登录' >> /docker-entrypoint-initdb.d/init.sh && \
    echo 'mysql -e "USE mysql; UPDATE user SET plugin='\''mysql_native_password'\'' WHERE User='\''root'\''; FLUSH PRIVILEGES;" 2>/dev/null || true' >> /docker-entrypoint-initdb.d/init.sh && \
    echo 'mysql -e "ALTER USER '\''root'\''@'\''localhost'\'' IDENTIFIED BY '\''${MYSQL_ROOT_PASSWORD}'\'';" 2>/dev/null || true' >> /docker-entrypoint-initdb.d/init.sh && \
    echo 'sleep 2' >> /docker-entrypoint-initdb.d/init.sh && \
    echo '# 使用新密码创建数据库' >> /docker-entrypoint-initdb.d/init.sh && \
    echo 'mysql -uroot -p${MYSQL_ROOT_PASSWORD} -e "CREATE DATABASE IF NOT EXISTS ${MYSQL_DATABASE};" 2>/dev/null || true' >> /docker-entrypoint-initdb.d/init.sh && \
    echo 'sleep 1' >> /docker-entrypoint-initdb.d/init.sh && \
    echo '# 导入SQL文件' >> /docker-entrypoint-initdb.d/init.sh && \
    echo 'mysql -uroot -p${MYSQL_ROOT_PASSWORD} ${MYSQL_DATABASE} < /app/RuoYi-v4.8.1/sql/ry_20250416.sql 2>/dev/null || true' >> /docker-entrypoint-initdb.d/init.sh && \
    echo 'mysql -uroot -p${MYSQL_ROOT_PASSWORD} ${MYSQL_DATABASE} < /app/RuoYi-v4.8.1/sql/quartz.sql 2>/dev/null || true' >> /docker-entrypoint-initdb.d/init.sh && \
    echo 'echo "Database initialization completed"' >> /docker-entrypoint-initdb.d/init.sh && \
    echo '# 创建标记文件通知RuoYi可以启动' >> /docker-entrypoint-initdb.d/init.sh && \
    echo 'touch /tmp/db-initialized' >> /docker-entrypoint-initdb.d/init.sh && \
    chmod +x /docker-entrypoint-initdb.d/init.sh

RUN echo '#!/bin/bash' > /app/start-ruoyi.sh && \
    echo '# 等待数据库初始化完成' >> /app/start-ruoyi.sh && \
    echo 'while [ ! -f /tmp/db-initialized ]; do' >> /app/start-ruoyi.sh && \
    echo '  echo "Waiting for database initialization..."' >> /app/start-ruoyi.sh && \
    echo '  sleep 2' >> /app/start-ruoyi.sh && \
    echo 'done' >> /app/start-ruoyi.sh && \
    echo 'echo "Database ready, starting RuoYi..."' >> /app/start-ruoyi.sh && \
    echo 'exec java -Xms128m -Xmx384m -XX:MetaspaceSize=64m -XX:MaxMetaspaceSize=128m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -jar /app/RuoYi-v4.8.1/ruoyi-admin/target/ruoyi-admin.jar' >> /app/start-ruoyi.sh && \
    chmod +x /app/start-ruoyi.sh

EXPOSE 80 3306 8080
# 启动supervisord
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
